---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import { existsSync } from "node:fs";
import { readFile } from "node:fs/promises";
import { join } from "node:path";
import type { MarkdownHeading } from "astro";

import ThesisDate from "@/components/thesis/date.astro";
import ReadingTime from "@/components/thesis/reading-time.astro";
import { ThesisTabs } from "@/components/thesis/tabs";
import TableOfContents from "@/components/toc/index.astro";
import { BackButton } from "@/components/ui/back-button";

import { CONFIG } from "@/lib/constants";
import type { ThesisType } from "@/lib/types";

import MainLayout from "./main.astro";

type Props = {
  thesis: CollectionEntry<ThesisType>;
  type: ThesisType;
  headings: MarkdownHeading[];
};

const {
  thesis: {
    body = "",
    data: { title, description, startDate, endDate, coverImage },
    id,
  },
  type,
  headings,
} = Astro.props;

let questionsData = null;
let incompleteData = null;
let hasQuestions = false;

try {
  const assetsPath = join(process.cwd(), "src", "assets", type, id);
  const quizPath = join(assetsPath, "questions.json");
  const incompletePath = join(assetsPath, "incomplete.json");

  if (existsSync(quizPath)) {
    const quizContent = await readFile(quizPath, "utf-8");
    questionsData = JSON.parse(quizContent);
    hasQuestions = true;
  }

  if (existsSync(incompletePath)) {
    const incompleteContent = await readFile(incompletePath, "utf-8");
    incompleteData = JSON.parse(incompleteContent);
    hasQuestions = true;
  }
} catch (error) {
  console.error("Error loading quiz data:", error);
}
---

<MainLayout title={`${title} - ${CONFIG.site.title}`} description={description}>
  <article>
    <BackButton href={`/${type}`} client:load />
    {
      coverImage && (
        <div class="rounded-md overflow-hidden aspect-video shadow-md dark:shadow-none">
          <Image
            class="rounded-[inherit] aspect-[inherit] object-cover"
            width={1020}
            height={510}
            src={import(`../assets/${type}/${id}/cover.jpg`)}
            alt=""
            draggable={false}
            transition:name={`${type}-${id}-cover`}
          />
        </div>
      )
    }
    <div class="mt-4">
      <ThesisTabs
        hasQuestions={hasQuestions}
        id={id}
        type={type}
        questionsData={questionsData}
        incompleteData={incompleteData}
        client:load
      >
        <div>
          <div class="pb-4 border-b">
            <h1
              class="text-3xl font-bold"
              transition:name={`${type}-${id}-title`}
            >
              {title}
            </h1>
            <p
              class="mt-2 text-muted-foreground"
              transition:name={`${type}-${id}-description`}
            >
              {description}
            </p>
            <div
              class="flex items-center gap-1 mt-1"
              transition:name={`${type}-${id}-other`}
            >
              <ThesisDate
                class="mt-0"
                type={type}
                id={id}
                startDate={startDate}
                endDate={endDate}
              />
              {
                body.length > 0 && startDate && endDate && (
                  <span class="text-muted-foreground text-xs">â€¢</span>
                )
              }
              <ReadingTime class="text-sm" content={body} />
            </div>
          </div>
          <div class="mt-4">
            <TableOfContents headings={headings} />
            <div class="typography" id="thesis">
              <slot />
            </div>
          </div>
        </div>
      </ThesisTabs>
    </div>
  </article>
</MainLayout>
